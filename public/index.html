<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ActionSchema</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #ffffff;
            font-family: Arial, sans-serif;
        }

        #container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        #center {
            position: relative;
            width: 150px;
            height: 150px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .logo {
            position: absolute;
            font-size: 32px;
            transition: transform 0.3s ease;
            z-index: 5;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.8));
            cursor: pointer;
        }

        .logo:hover {
            transform: scale(1.2);
        }

        svg {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        path {
            fill: none;
            stroke-width: 2;
            opacity: 0.3;
        }

        #outer-glow {
            position: absolute;
            width: 76%;
            height: 76%;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0) 70%);
            z-index: 1;
        }

        #search-container {
            position: relative;
            width: 300px;
            z-index: 20;
        }

        #search-input {
            width: 100%;
            height: 40px;
            font-size: 16px;
            padding: 5px 10px 5px 10px;
            border: 2px solid #4CAF50;
            border-radius: 20px;
            outline: none;
        }

        #search-input:focus {
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        #mic-button {
            position: absolute;
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #4CAF50;
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 14px;
        }

        #mic-button:hover {
            background-color: #45a049;
        }

        #timer {
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            color: #4CAF50;
            display: none;
        }
    </style>
</head>

<body>
    <div id="container">
        <svg></svg>
        <div id="outer-glow"></div>
        <div id="center">
            <svg class="h-16 w-16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                <path d="M10 90 L50 10 L90 90 M50 75 A5 5 0 1 1 50 85 A5 5 0 1 1 50 75" stroke="#4CAF50"
                    stroke-width="12" fill="none" />
            </svg>
        </div>
        <div id="search-container">
            <input type="text" id="search-input" placeholder="Type your request" autofocus>
            <button id="mic-button"><i class="fas fa-microphone"></i></button>
            <span id="timer">00:00</span>
        </div>
    </div>

    <script>
        const container = document.getElementById('container');
        const svg = document.querySelector('svg');
        const center = document.getElementById('center');
        const searchInput = document.getElementById('search-input');
        const micButton = document.getElementById('mic-button');
        const timer = document.getElementById('timer');

        let mediaRecorder;
        let audioChunks = [];
        let startTime;
        let timerInterval;
        let isRecording = false;

        const isMobile = window.innerWidth < 1024;
        const desktopLogos = isMobile ? [] : [
            //{ icon: 'fa-pinterest', color: '#BD081C', placeholder: 'Find DIY project ideas' },
            //{ icon: 'fa-snapchat', color: '#FFFC00', placeholder: 'Create a custom AR filter' },
            //{ icon: 'fa-tiktok', color: '#000000', placeholder: 'Start a dance challenge' },
            //{ icon: 'fa-reddit', color: '#FF4500', placeholder: 'Ask for advice on r/AskReddit' },
            //{ icon: 'fa-twitch', color: '#9146FF', placeholder: 'Start streaming your gameplay' },
            //{ icon: 'fa-paypal', color: '#00457C', placeholder: 'Send money to a friend' },
            ///{ icon: 'fa-ethereum', color: '#3C3C3D', placeholder: 'Check ETH gas fees' },
            //{ icon: 'fa-bitcoin', color: '#F7931A', placeholder: 'Convert BTC to USD' },
            //{ icon: 'fa-dropbox', color: '#0061FF', placeholder: 'Share a large file' },
            //{ icon: 'fa-android', color: '#3DDC84', placeholder: 'Download latest Android update' },
            //{ icon: 'fa-docker', color: '#2496ED', placeholder: 'Pull latest image' },
            //{ icon: 'fa-unity', color: '#000000', placeholder: 'Import 3D model' },
            //{ icon: 'fa-facebook', color: '#1877F2', placeholder: 'Create a new event' },
            //{ icon: 'fa-instagram', color: '#E4405F', placeholder: 'Edit photo with new filter' },

        ];

        const logos = [
            { icon: 'fa-google', color: '#4285F4', placeholder: 'Search for nearby restaurants' },
            { icon: 'fa-apple', color: '#A2AAAD', placeholder: 'Check iPhone battery health' },
            { icon: 'fa-microsoft', color: '#00A4EF', placeholder: 'Schedule a Teams meeting' },
            { icon: 'fa-amazon', color: '#FF9900', placeholder: 'Track my package' },
            { icon: 'fa-slack', color: '#4A154B', placeholder: 'Create a new channel' },
            { icon: 'fa-jira', color: '#0052CC', placeholder: 'Create a new sprint' },
            { icon: 'fa-trello', color: '#0052CC', placeholder: 'Add a new card to board' },
            { icon: 'fa-aws', color: '#232F3E', placeholder: 'Launch an EC2 instance' },
            { icon: 'fa-npm', color: '#CB3837', placeholder: 'Install a package' },
            { icon: 'fa-twitter', color: '#1DA1F2', placeholder: 'Tweet about #TechTrends' },
            { icon: 'fa-linkedin', color: '#0A66C2', placeholder: 'Update my work experience' },
            { icon: 'fa-youtube', color: '#FF0000', placeholder: 'Upload a new video' },
            { icon: 'fa-whatsapp', color: '#25D366', placeholder: 'Start a group video call' },
            { icon: 'fa-spotify', color: '#1ED760', placeholder: 'Create a workout playlist' },
            { icon: 'fa-stripe-s', color: '#008CDD', placeholder: 'Set up recurring payments' },
            { icon: 'fa-github', color: '#181717', placeholder: 'Create a new repository' },
            { icon: 'fa-cloudflare', color: '#F38020', placeholder: 'Configure DNS settings' },
            ...desktopLogos
        ];

        let animationFrame;
        let isMouseInside = false;
        let autoAnimationAngle = 0;

        function createLogo(logo, x, y) {
            const logoElement = document.createElement('i');
            logoElement.className = `fab ${logo.icon} logo`;
            logoElement.style.left = `${x}px`;
            logoElement.style.top = `${y}px`;
            logoElement.style.color = logo.color;
            logoElement.setAttribute('data-placeholder', logo.placeholder);
            container.appendChild(logoElement);

            logoElement.addEventListener('mouseenter', () => {
                searchInput.placeholder = logo.placeholder;
            });

            logoElement.addEventListener('mouseleave', () => {
                searchInput.placeholder = "Type your request";
            });
        }

        function createCurves() {
            const curves = [];
            const numCurves = 200;
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;

            for (let i = 0; i < numCurves; i++) {
                const angle = (i / numCurves) * Math.PI * 2;
                const radius = Math.min(window.innerWidth, window.innerHeight) * 0.4;
                const x = centerX + Math.cos(angle) * radius;
                const y = centerY + Math.sin(angle) * radius;

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const d = `M ${centerX} ${centerY} Q ${centerX} ${centerY} ${x} ${y}`;
                path.setAttribute('d', d);
                path.setAttribute('stroke', `hsl(${(i / numCurves) * 360}, 70%, 50%)`);
                svg.appendChild(path);
                curves.push({ path, endX: x, endY: y });
            }

            return curves;
        }

        function updateCurves(curves, mouseX, mouseY) {
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;

            curves.forEach((curve, index) => {
                const dx = curve.endX - centerX;
                const dy = curve.endY - centerY;
                const distance = Math.sqrt(dx * dx + dy * dy);

                const midX = centerX + dx * 0.5 + (mouseX - centerX) * 0.1 * (distance / 100);
                const midY = centerY + dy * 0.5 + (mouseY - centerY) * 0.1 * (distance / 100);

                const d = `M ${centerX} ${centerY} Q ${midX} ${midY} ${curve.endX} ${curve.endY}`;
                curve.path.setAttribute('d', d);

                const hue = (index / curves.length * 360 + (mouseX + mouseY) / 5) % 360;
                curve.path.setAttribute('stroke', `hsl(${hue}, 70%, 50%)`);
            });
        }

        function isPointInsideCircle(x, y, centerX, centerY, radius) {
            const dx = x - centerX;
            const dy = y - centerY;
            return dx * dx + dy * dy <= radius * radius;
        }

        function autoAnimate(curves) {
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            const radius = Math.min(window.innerWidth, window.innerHeight) * 0.2;

            autoAnimationAngle += 0.02;
            const mouseX = centerX + Math.cos(autoAnimationAngle) * radius;
            const mouseY = centerY + Math.sin(autoAnimationAngle) * radius;

            updateCurves(curves, mouseX, mouseY);
            animationFrame = requestAnimationFrame(() => autoAnimate(curves));
        }

        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();
                    isRecording = true;

                    audioChunks = [];
                    mediaRecorder.addEventListener("dataavailable", event => {
                        audioChunks.push(event.data);
                    });

                    startTime = Date.now();
                    updateTimer();
                    timerInterval = setInterval(updateTimer, 1000);

                    micButton.innerHTML = '<i class="fas fa-stop"></i>';
                    timer.style.display = 'inline';
                })
                .catch(error => {
                    console.error('Error accessing microphone:', error);
                });
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.addEventListener("stop", () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    sendAudioToServer(audioBlob);
                });

                mediaRecorder.stop();

                isRecording = false;
                clearInterval(timerInterval);
                timer.style.display = 'none';
                micButton.innerHTML = '<i class="fas fa-microphone"></i>';
            }
        }

        // Meta is Command on Mac and Windows key on Windows
        const triggerKeys = ['Control', 'Alt', 'Meta'];

        document.addEventListener('keydown', function (event) {
            if (triggerKeys.includes(event.key) && !isRecording) {
                startRecording();
            }
        });

        document.addEventListener('keyup', function (event) {
            if (triggerKeys.includes(event.key) && isRecording) {
                stopRecording();
            }
        });

        function updateTimer() {
            const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsedSeconds / 60);
            const seconds = elapsedSeconds % 60;
            timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function sendAudioToServer(audioBlob) {
            const formData = new FormData();
            formData.append('audio', audioBlob, 'recording.wav');

            // Create a form element
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = 'search.html';

            // Append the FormData to the form
            for (let [key, value] of formData.entries()) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value;
                form.appendChild(input);
            }

            // Append the form to the body and submit it
            document.body.appendChild(form);
            form.submit();
        }

        function init() {
            const curves = createCurves();
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            const circleRadius = Math.min(window.innerWidth, window.innerHeight) * 0.38;

            logos.forEach((logo, index) => {
                const angle = (index / logos.length) * Math.PI * 2;
                const x = centerX + Math.cos(angle) * circleRadius - 16;
                const y = centerY + Math.sin(angle) * circleRadius - 16;
                createLogo(logo, x, y);
            });

            document.addEventListener('mousemove', (e) => {
                if (isPointInsideCircle(e.clientX, e.clientY, centerX, centerY, circleRadius)) {
                    if (!isMouseInside) {
                        isMouseInside = true;
                        cancelAnimationFrame(animationFrame);
                    }
                    updateCurves(curves, e.clientX, e.clientY);
                } else {
                    if (isMouseInside) {
                        isMouseInside = false;
                        autoAnimate(curves);
                    }
                }
            });

            document.addEventListener('mouseleave', () => {
                isMouseInside = false;
                autoAnimate(curves);
            });

            window.addEventListener('resize', () => {
                svg.innerHTML = '';
                container.querySelectorAll('.logo').forEach(logo => logo.remove());
                cancelAnimationFrame(animationFrame);
                init();
            });

            // Start with auto animation
            autoAnimate(curves);

            const isQuerySearchableValidator = (q) => {
                return true;
            }
            // Add event listener for search input
            searchInput.addEventListener('keypress', async function (e) {
                if (e.key === 'Enter') {
                    handleSearch();
                    return;
                }
                const isLetter = 'abcdefghijklmnopqrstuvwxyz'.split("").find(k => k === e.key.toLowerCase())


                if (isQuerySearchableValidator(searchInput.value)) {
                    // Do prefetch search
                    const q = encodeURIComponent(searchInput.value + e.key).toLowerCase();
                    const localStorageKey = `search.${q}`;
                    const already = localStorage.getItem(localStorageKey);
                    if (!already || JSON.parse(already).createdAt < Date.now() - 86400000) {
                        const result = await fetch(`https://search.actionschema.com/api/search/providers?q=${q}`).then(res => res.json())
                        localStorage.setItem(localStorageKey, JSON.stringify(result));
                        // console.log(`searched and found: ` + q);
                    } else {
                        // console.log("already have: " + q);
                    }
                }


            });

            // Add event listener for microphone button
            micButton.addEventListener('click', function () {
                if (isRecording) {
                    stopRecording();
                } else {
                    startRecording();
                }
            });
        }

        function handleSearch() {
            const query = encodeURIComponent(searchInput.value);
            window.location.href = `search.html?q=${query}`;
        }

        init();
    </script>
</body>

</html>